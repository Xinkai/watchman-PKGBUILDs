# Maintainer: Xinkai Chen <xinkai.chen@qq.com>

_pkgname=mvfst
pkgname=${_pkgname}-weekly
pkgver=2023.12.04.00
pkgrel=1
pkgdesc="An implementation of the QUIC transport protocol."
arch=("x86_64")
url="https://github.com/facebook/mvfst"
license=("Apache")
depends=("folly-weekly" "fizz-weekly")
makedepends=("boost=1.83.0" "cmake")
conflicts=("mvfst")
provides=("mvfst")
source=("$url/archive/v${pkgver}.tar.gz")
b2sums=('68197e0303a7d9b6e845f74ad765c8daaa8838ee2cc10df385f922fd24b25d92731bcade21251c6f326dd0dac9e25cb42b5409e34fc163260642ddce668fd6c4')
options=(!lto)

build() {
  cd "$_pkgname-$pkgver"
  cmake \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_LIBRARY_ARCHITECTURE=x86_64_v3 \
    -DBUILD_TESTS=OFF \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -S . -B _build
  cmake --build _build
}

check() {
  cd "$_pkgname-$pkgver"
  # cmake --build _build --target test
}

package() {
  cd "$_pkgname-$pkgver"
  cmake --build _build --target install -- DESTDIR="$pkgdir/"
  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
