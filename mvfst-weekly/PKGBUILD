# Maintainer: Xinkai Chen <xinkai.chen@qq.com>

_pkgname=mvfst
pkgname=${_pkgname}-weekly
pkgver=2024.02.12.00
pkgrel=1
pkgdesc="An implementation of the QUIC transport protocol."
arch=("x86_64")
url="https://github.com/facebook/mvfst"
license=("Apache")
depends=("folly-weekly" "fizz-weekly")
makedepends=("boost=1.83.0" "cmake")
conflicts=("mvfst")
provides=("mvfst")
source=("$url/archive/v${pkgver}.tar.gz")
b2sums=('a34ef3333c6c83f4c4cfe03fccaaf60cd09ecacea9e92f9cbd216a1e06d5701f1235b5210e22c925eb3124e10d21a0ebba89353ca2526dcccd3eca8bcfc72cae')
options=(!lto)

build() {
  cd "$_pkgname-$pkgver"
  cmake \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_LIBRARY_ARCHITECTURE=x86_64_v3 \
    -DBUILD_TESTS=OFF \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -S . -B _build
  cmake --build _build
}

check() {
  cd "$_pkgname-$pkgver"
  # cmake --build _build --target test
}

package() {
  cd "$_pkgname-$pkgver"
  cmake --build _build --target install -- DESTDIR="$pkgdir/"
  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
