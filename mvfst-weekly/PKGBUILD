# Maintainer: Xinkai Chen <xinkai.chen@qq.com>

_pkgname=mvfst
pkgname=${_pkgname}-weekly
pkgver=2023.12.11.00
pkgrel=1
pkgdesc="An implementation of the QUIC transport protocol."
arch=("x86_64")
url="https://github.com/facebook/mvfst"
license=("Apache")
depends=("folly-weekly" "fizz-weekly")
makedepends=("boost=1.83.0" "cmake")
conflicts=("mvfst")
provides=("mvfst")
source=("$url/archive/v${pkgver}.tar.gz")
b2sums=('b83ab314968ac8aaf452743a2670437fd8905aedad09d8c222f01e1a5092a0302694b98bd0c776a837c69b3f9b796b52cfae8ed01402e5f7bcda13b993e3056a')
options=(!lto)

build() {
  cd "$_pkgname-$pkgver"
  cmake \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_LIBRARY_ARCHITECTURE=x86_64_v3 \
    -DBUILD_TESTS=OFF \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -S . -B _build
  cmake --build _build
}

check() {
  cd "$_pkgname-$pkgver"
  # cmake --build _build --target test
}

package() {
  cd "$_pkgname-$pkgver"
  cmake --build _build --target install -- DESTDIR="$pkgdir/"
  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
