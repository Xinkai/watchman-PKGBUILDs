# Maintainer: Xinkai Chen <xinkai.chen@qq.com>

_pkgname=mvfst
pkgname=${_pkgname}-weekly
pkgver=2023.08.28.00
pkgrel=2
pkgdesc="An implementation of the QUIC transport protocol."
arch=("x86_64")
url="https://github.com/facebook/mvfst"
license=("Apache")
depends=("folly-weekly" "fizz-weekly")
makedepends=("boost=1.83.0" "cmake")
conflicts=("mvfst")
provides=("mvfst")
source=("$url/archive/v${pkgver}.tar.gz")
b2sums=('a3abe9b9b6623a6b8bbf5ccb092f54d56114c9b708b45932753235cae6ceb354899740bb7b9e563966e4c9c2c9b2c3b3ef090e41f7019329d06aaee3a601a3aa')
options=(!lto)

build() {
  cd "$_pkgname-$pkgver"
  cmake \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_LIBRARY_ARCHITECTURE=x86_64_v3 \
    -DBUILD_TESTS=OFF \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -S . -B _build
  cmake --build _build
}

check() {
  cd "$_pkgname-$pkgver"
  # cmake --build _build --target test
}

package() {
  cd "$_pkgname-$pkgver"
  cmake --build _build --target install -- DESTDIR="$pkgdir/"
  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
